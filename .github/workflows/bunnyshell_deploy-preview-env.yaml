name: Bunnyshell - Deploy Preview Environment
on:
  workflow_run:
    workflows:
      - "Bunnyshell - Prepare Preview Environment Configuration"
    types:
      - completed
permissions:
  pull-requests: write
jobs:
  load-artifact-from-reusable:
    name: Load artifact values
    uses: bunnyshell/workflows/.github/workflows/load-artifact.yaml@v2
    with:
      workflow_run_id: ${{ github.event.workflow_run.id }}

  deploy:
    name: Deploy Environment
    needs: load-artifact-from-reusable
    uses: bunnyshell/workflows/.github/workflows/deploy-env.yaml@v2
    concurrency: bns-deploy-${{ needs.load-artifact-from-reusable.outputs.pr-number }}
    if: ${{ github.event.workflow_run.conclusion == 'success' && needs.load-artifact-from-reusable.outputs.skip-deployment == 'false' }}
    with:
      pr-number: ${{ needs.load-artifact-from-reusable.outputs.pr-number }}
      project-id: ${{ vars.BUNNYSHELL_PROJECT_ID }}
      cluster-id: ${{ vars.BUNNYSHELL_CLUSTER_ID }}
      env-name: "Demo PR #${{ needs.load-artifact-from-reusable.outputs.pr-number }}"
      bunnyshell-yaml-contents: "kind: Environment\nname: preview\ntype: primary\nurlHandle: devopsavanspreview\ncomponents:\n    -\n        kind: Application\n        name: clock-service\n        gitRepo: 'https://github.com/Mees-H/WEBS_EINDOPDRACHT.git'\n        gitBranch: main\n        gitApplicationPath: clock-service\n        dockerCompose:\n            build:\n                context: ./clock-service\n                dockerfile: Dockerfile\n            deploy:\n                resources:\n                    limits:\n                        cpus: '0.50'\n                        memory: '209715200'\n            environment:\n                MONGODB_URL: 'mongodb://mongodb:27017/clocker'\n                RABBITMQ_URL: 'amqp://user:password@rabbitmq:5672'\n            ports:\n                - '3007:3007'\n        hosts:\n            -\n                hostname: 'clock-service-{{ env.base_domain }}'\n                path: /\n                servicePort: 3007\n    -\n        kind: Application\n        name: mail-service\n        gitRepo: 'https://github.com/Mees-H/WEBS_EINDOPDRACHT.git'\n        gitBranch: main\n        gitApplicationPath: mail-service\n        dockerCompose:\n            build:\n                context: ./mail-service\n                dockerfile: Dockerfile\n            deploy:\n                resources:\n                    limits:\n                        cpus: '0.50'\n                        memory: '209715200'\n            environment:\n                RABBITMQ_URL: 'amqp://user:password@rabbitmq:5672'\n                SENDER_EMAIL: image.contest.info@gmail.com\n                SENDER_PASSWORD: 'neot qpim rapa fhol'\n            ports:\n                - '3004:3004'\n        hosts:\n            -\n                hostname: 'mail-service-{{ env.base_domain }}'\n                path: /\n                servicePort: 3004\n    -\n        kind: Database\n        name: mongodb\n        dockerCompose:\n            deploy:\n                resources:\n                    limits:\n                        cpus: '0.50'\n                        memory: '314572800'\n            image: mongo\n            ports:\n                - '27018:27017'\n    -\n        kind: Service\n        name: nginx\n        dockerCompose:\n            deploy:\n                resources:\n                    limits:\n                        cpus: '0.50'\n                        memory: '104857600'\n            image: 'nginx:latest'\n            ports:\n                - '3000:80'\n        hosts:\n            -\n                hostname: 'nginx-{{ env.base_domain }}'\n                path: /\n                servicePort: 3000\n    -\n        kind: Service\n        name: rabbitmq\n        dockerCompose:\n            deploy:\n                resources:\n                    limits:\n
               cpus: '0.75'\n                        memory: '524288000'\n            environment:\n                RABBITMQ_DEFAULT_PASS: password\n                RABBITMQ_DEFAULT_USER: user\n            image: 'rabbitmq:3-management'\n            ports:\n                - '5672:5672'\n                - '15672:15672'\n        hosts:\n            -\n                hostname: 'rabbitmq-{{ env.base_domain }}'\n                path: /\n                servicePort: 5672\n    -\n        kind: Application\n        name: read-service\n        gitRepo: 'https://github.com/Mees-H/WEBS_EINDOPDRACHT.git'\n        gitBranch: main\n        gitApplicationPath: read-service\n        dockerCompose:\n            build:\n                context: ./read-service\n                dockerfile: Dockerfile\n            deploy:\n                resources:\n                    limits:\n
        cpus: '0.50'\n                        memory: '209715200'\n            environment:\n                MONGODB_URL: 'mongodb://mongodb:27017/reader'\n                RABBITMQ_URL: 'amqp://user:password@rabbitmq:5672'\n            ports:\n
      - '3006:3006'\n        hosts:\n            -\n                hostname: 'read-service-{{ env.base_domain }}'\n
     path: /\n                servicePort: 3006\n    -\n        kind: Application\n        name: score-service\n        gitRepo: 'https://github.com/Mees-H/WEBS_EINDOPDRACHT.git'\n        gitBranch: main\n        gitApplicationPath: score-service\n        dockerCompose:\n            build:\n                context: ./score-service\n                dockerfile: Dockerfile\n            deploy:\n                resources:\n                    limits:\n                        cpus: '0.50'\n
      memory: '209715200'\n            environment:\n                MONGODB_URL: 'mongodb://mongodb:27017/scores'\n
     RABBITMQ_URL: 'amqp://user:password@rabbitmq:5672'\n            ports:\n                - '3005:3005'\n        hosts:\n            -\n                hostname: 'score-service-{{ env.base_domain }}'\n                path: /\n                servicePort: 3005\n    -\n        kind: Application\n        name: sharpshooter-service\n        gitRepo: 'https://github.com/Mees-H/WEBS_EINDOPDRACHT.git'\n        gitBranch: main\n        gitApplicationPath: sharpshooter-service\n        dockerCompose:\n            build:\n                context: ./sharpshooter-service\n                dockerfile: Dockerfile\n            deploy:\n                resources:\n                    limits:\n                        cpus: '0.50'\n                        memory: '209715200'\n            environment:\n                IMGUR_CLIENT_ID: 09fb55a80442763\n                JWT_SECRET: veryLongAndSecureSecretKeyThatNoOneCanGuess\n                MONGODB_URL: 'mongodb://mongodb:27017/shots'\n                PORT: '3002'\n                RABBITMQ_URL: 'amqp://user:password@rabbitmq:5672'\n            ports:\n                - '3002:3002'\n        hosts:\n            -\n                hostname: 'sharpshooter-service-{{ env.base_domain }}'\n                path: /\n
     servicePort: 3002\n    -\n        kind: Application\n        name: target-service\n        gitRepo: 'https://github.com/Mees-H/WEBS_EINDOPDRACHT.git'\n        gitBranch: main\n        gitApplicationPath: target-service\n        dockerCompose:\n            build:\n                context: ./target-service\n                dockerfile: Dockerfile\n            deploy:\n                resources:\n                    limits:\n                        cpus: '0.50'\n                        memory: '209715200'\n            environment:\n                IMGUR_CLIENT_ID: 09fb55a80442763\n                JWT_SECRET: veryLongAndSecureSecretKeyThatNoOneCanGuess\n                MONGODB_URL: 'mongodb://mongodb:27017/targets'\n                PORT: '3001'\n                RABBITMQ_URL: 'amqp://user:password@rabbitmq:5672'\n            ports:\n                - '3001:3001'\n        hosts:\n            -\n                hostname: 'target-service-{{ env.base_domain }}'\n                path: /\n                servicePort: 3001\n    -\n        kind: Application\n        name: user-service\n        gitRepo: 'https://github.com/Mees-H/WEBS_EINDOPDRACHT.git'\n        gitBranch: main\n        gitApplicationPath: user-service\n        dockerCompose:\n            build:\n                context: ./user-service\n                dockerfile: Dockerfile\n            deploy:\n                resources:\n                    limits:\n                        cpus: '0.50'\n                        memory: '209715200'\n
   environment:\n                IMGUR_CLIENT_ID: 09fb55a80442763\n                JWT_EXPIRE_TIME: 1d\n                JWT_SECRET: veryLongAndSecureSecretKeyThatNoOneCanGuess\n                MONGODB_URL: 'mongodb://mongodb:27017/users'\n
 PORT: '3003'\n                RABBITMQ_URL: 'amqp://user:password@rabbitmq:5672'\n            ports:\n                - '3003:3003'\n        hosts:\n            -\n                hostname: 'user-service-{{ env.base_domain }}'\n                path: /\n                servicePort: 3003\n"
      comment-on-pr: true
    secrets:
      bunnyshell-access-token: ${{ secrets.BUNNYSHELL_ACCESS_TOKEN }}
